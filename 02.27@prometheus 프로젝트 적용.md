### 1. 정리
- prometheus는 노드 당 하나만 생성
	- 필터링으로 적절하게 pod을 선택해야 한다


### 2. 모니터링 방법

#### 1) prometheus

```
container_network_receive_bytes_total {
  id=~"/system.slice/containerd.service/.*",
  pod=~"nginx-deployment-.*"
  namespace="nginx-test"
}
```

```
container_memory_usage_bytes {
  id=~"/system.slice/containerd.service/.*",
  image="docker.io/library/nginx:latest",
  namespace="nginx-test"
}
```
- 알아야 하는 정보
	- namespace : 서비스가 속한 namespace
	- image: pod의 이미지 
		- "registry.k8s.io/pause:3.6": 이 이미지는 Kubernetes 시스템 내부에서 주로 사용되며, 파드의 네트워크 네임스페이스를 생성하고 관리하는 데 사용됩니다. 파드의 다른 컨테이너가 시작되기 전에 pause 컨테이너가 먼저 시작되어 파드의 네트워크 네임스페이스를 설정하고 유지합니다.
		- "docker.io/library/nginx:latest": 이 이미지는 Nginx 웹 서버를 실행하는 데 사용됩니다. 웹 애플리케이션을 호스팅하거나 정적 파일을 서빙하는 데 사용될 수 있습니다.

#### 2) grafana

- 이미 만들어진 grafana dashboard가 존재
- http://192.168.64.17:32183/d/a87fb0d919ec0ea5f6543124e16c42a5/kubernetes-compute-resources-namespace-workloads?orgId=1&refresh=10s&var-datasource=default&var-cluster=&var-namespace=nginx-test&var-type=All (Compute Resources filtered by Namespace-Workload)
- http://192.168.64.17:32183/d/bbb2a765a623ae38130206c7d94a160f/kubernetes-networking-namespace-workload?orgId=1&refresh=10s&var-datasource=default&var-cluster=&var-namespace=nginx-test&var-type=All&var-resolution=5m&var-interval=4h (Network filtered by Namespace-Workload)
- 단점?
	- user를 만들 수 있는데, 역할이 viewer / editor / admin 으로 구성
		- 역할 커스터마이징이 없음
	- viewer user는 다른 네임스페이스도 확인할 수 있는 문제
	- 방법?


```yaml
# values.yaml

prometheus:
  prometheusSpec:
    serviceMonitorSelectorNilUsesHelmValues: false
    serviceMonitorSelector: {}
    serviceMonitorNamespaceSelector: {}
  service:
    type: NodePort

grafana:
  grafana.ini:
    security:
      allow_embedding: true
    auth.anonymous:
      enabled: true
  service:
    type: NodePort
    nodePort: 30300

alertmanager:
  service:
    type: NodePort
```

- 하나의 대시보드에서 네임스페이스로 필터링하는 것은 보안 취약 요소
	- 다른 네임스페이스에 있는 자료를 볼 수 있음

- 대시보드 자체를 user 별로 권한을 줄 수 있다
	- 하지만 네임스페이스 별로 권한을 줄 수 없다
	- 따로 대시보드를 만든다면?
		- 서비스가 추가될 때마다 동적으로 대시보드가 추가되어야 함
		- 이럴거면 서비스마다 프로메테우스를 따로 세팅하는 것이 더 편함



```shell
sudo apt install spice-vdagent
sudo apt install spice-webdavd

# [mount point] = 어디로 받을건지 path 넣어주면 됨
sudo mkdir [mount point]
sudo mount -t 9p -o trans=virtio share [mount point] -oversion=9p2000.L
```
- shared directory

#### 3) grafana 프로젝트 custumization

```shell
git clone https://github.com/grafana/grafana
```

```shell
# backend
brew install go
make

# frontend
brew install yarn
yarn install --pure-lockfile
yarn start
```
- https://github.com/grafana/grafana/blob/main/contribute/developer-guide.md
- https://grafana.com/blog/2021/03/03/how-to-set-up-a-grafana-development-environment-on-a-windows-pc-using-wsl/