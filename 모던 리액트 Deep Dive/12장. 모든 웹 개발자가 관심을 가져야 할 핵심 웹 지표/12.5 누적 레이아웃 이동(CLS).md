# 12.5 누적 레이아웃 이동(CLS)

## 정의

- Cumulative Layout Shift
- 모든 예기치 않은 이동에 대한 지표를 계산하는 것이다.
- 낮을수록 좋은 지표이다.
- LCP와 마찬가지로 뷰포트 밖의 요소에 대해서는 측정하지 않는다.

## 의미

- 과거의 웹 사이트는 제공하는 정보가 한정적이었다. 단순히 서버에서 완성된 HTML과 자바스크립트를 다운로드받아 브라우저에서 보여주면 된다.
- 하지만 현재는 리액트의 도움으로 동적인 웹 사이트를 만들 수 있다. 예를 들어, useEffect 내부에 비동기 요청 후에 UI를 변경하는 작업이 있는 경우 사용자가 페이지를 보는 중간에 UI가 변경될 수 있다.
- 요소가 추가되었다고 CLS가 높아지는 것은 아니다. 요소가 추가되었을 때, 그 요소가 추가되기 전에 있던 요소들이 이동하는 것이다.
- 사용자가 아무런 동작을 하지 않았음에도 불구하고 레이아웃 이동이 발생하는 경우만 해당한다.
- 점수 = 영향분율 \* 거리분율

## 예제

- CLS는 기기의 크기에 따라 점수가 다르게 측정될 수 있다.
- 보통 뷰포트의 높이가 더 작은 기기에서 더 낮은 점수를 받는다.(CLS를 발생시키는 요소의 크기가 동일하다는 가정 하)
- 하지만 불편함을 겪는다는 사실은 결국 똑같다.
- 대부분의 서비스들은 스켈레톤 UI를 사용하여 페이지 레이아웃을 고정시켰다. 로딩이 완료되면 스켈레톤 UI를 없애고 실제 컨텐츠를 보여준다.
- 유튜브에서는 광고가 필요한지가 클라이언트에서 결정되기 때문에, 갑자기 위에서 div가 나타나면서 컨텐츠를 밀어냈고 CLS가 발생했다.
- 미리 노출이 예상되는 부분을 HTML로 자리 잡아 두는 것(e.g. 스켈레톤 UI)이 CLS 지표에 도움이 된다는 것을 알았다.
- 사용자는 미리 노출이 예상되는 부분을 예측할 수 있다는 장점이 있다.
- 물론 광고처럼 동적으로 결정되는 요소까지 예측해서 서버에서 렌더링하는 것도 방법이 될 수 있지만, 추가적인 부담이 될 수 있기 때문에 신중하게 결정해야 한다.

## 기준 점수

- Good: 0.1 이내
- Needs Improvement: 0.1 ~ 0.25
- Poor: 0.25 이상

## 개선 방안

### 삽입이 예상되는 요소를 위한 추가적인 공간 확보

- 대부분의 큰 CLS는 클라이언트에서 삽입되는 동적인 요소로 인해 발생한다.
- useEffect 내부에서 요소를 추가하는 작업을 최소화한다.
- useLayoutEffect를 사용하여 렌더링 전에 요소를 동기적으로 추가하는 작업을 수행한다. 하지만 동기적인 작업이기 때문에, 전체 작업에 영향을 미칠 수 있음에 유의해야 한다.
- 스켈레톤 UI처럼, 동적으로 뜰 것으로 예상되는 공간을 미리 확보해둔다.
- 서버 사이드 렌더링을 이용하여 서버에서 렌더링된 페이지를 클라이언트에게 전달한다. 그러나 타사 스크립트를 사용하는 경우에는 서버 사이드 렌더링을 사용할 수 없다.
- 가능한 한 최초 뷰포트에 영향을 미치지 않는 곳으로 미뤄두는 것이 좋다(회피).

### 폰트 로딩 최적화

- 폰트 또한 레이아웃이동을 일으키는 원인 중 하나이다. 폰트로 인해 발생할 수 있는 문제는 다음과 같다.
  1.  Flash of Unstyled Text: 대체 기본 폰트로 렌더링된 후, 실제 폰트로 교체되는 현상
  2.  Flash of Invisible Text: 텍스트가 보이지 않다가, 실제 폰트가 적용된 텍스트가 보이는 현상
- FOUT는 폰트가 교체되면서, FOIT는 텍스트가 렌더링되면서 CLS가 발생할 수 있다.
- 최적화를 하는 방법은 다음과 같다.
  1. <link>의 rel=preload 속성을 사용하여 폰트를 미리 로드한다.
  2. font-family에서 폰트를 불러오는 방법을 설정한다
     - block(폰트가 로드될 때까지 렌더링을 차단)
     - swap(FOUT; 폰트가 로드될 때까지 기본 폰트로 렌더링 로드되면 교체)
     - fallback(폰트가 로드될 때까지 기본 폰트로 렌더링 로드되면 교체, 3초 안에 폰트가 로드되지 않으면 기본 폰트를 유지)
     - optional(fallback과 유사하나, 폰트를 다운로드하지 못하면 취소)
- CLS를 줄이기 위해서는 두 가지 방법을 조합하여 사용하는 것이 좋다.
- 즉, 폰트를 preload로 미리 다운로드하고 빠르게 다운로드에 실패했다면 다음을 기약하고 기본 폰트를 노출하는 것이다.

### 적절한 이미지 크기 설정

```CSS
img {
	width: 100%;
	height: auto;
}
```

- 너비는 기기의 너비대로, 높이는 기기가 아니라 이미지의 비율에 맞게 설정한다.
- 그러나 CLS가 커지는 결과를 낳는다. 높이는 이미지가 다운로드되기 전에는 알 수 없기 때문에 높이의 변화가 발생하기 때문이다.

```HTML
<img src="image.jpg" width="1600" height="900" />
```

- 이미지의 크기를 미리 설정하면, 이미지가 로드되기 전에 이미지의 크기를 알 수 있기 때문에 CLS가 줄어든다.
- 반응형 이미지를 사용하고 싶다면, srcset 속성을 사용한다.(각각은 ,로 구분되어야 하며 너비를 알려주는 w를 사용해야 한다)
