## 1. vm에서 nginx 모니터링 구축하기

### prometheus 설치

```shell
# prometheus 설치
sudo apt-get update
sudo apt-get install prometheus
```

```yaml
# prometheus.yml
# Sample config for Prometheus.

global:
  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

  # Attach these labels to any time series or alerts when communicating with
  # external systems (federation, remote storage, Alertmanager).
  external_labels:
      monitor: 'example'

# Alertmanager configuration
alerting:
  alertmanagers:
  - static_configs:
    - targets: ['localhost:9093']

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: 'prometheus'

    # Override the global default and scrape targets from this job every 5 seconds.
    scrape_interval: 5s
    scrape_timeout: 5s

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ['localhost:9090']

  - job_name: node
    # If prometheus-node-exporter is installed, grab stats about the local
    # machine by default.
    static_configs:
      - targets: ['localhost:9100']
```
- job_name
	- prometheus : prometheus 프로세스 자체의 메트릭 정보를 수집
	- node : node-exporter 프로세스를 통해 host 시스템 메트릭 정보 수집

```shell
sudo systemctl restart prometheus
```
### Architecture

![architecture](./img/02.19/architecture.png)
- prometheus server는 설정 파일에 선언된 targets의 특정 url(default : /metric)으로부터 pull 해온 메트릭 정보를 저장
- 
### 헬스 체크

```shell
curl http://localhost:9090/graph # 1)

curl http://localhost:9090/metrics # 2)
curl http://localhost:9100/metrics # 3)
```
1) prometheus가 수집한 메트릭 정보를 간단하게 조회할 수 있는 서버(EXPRESSION BROWSER)
2) prometheus의 내부 정보를 export
3) host 시스템 메트릭 정보를 export

### nginx 모니터링

- nginx의 stub module 정보를 prometheus에서 요구하는 양식으로 변환하여 expose하는 nginx-prometheus-exporter 모듈이 필요함
- http://localhost:80/metrics (nginx) => http://localhost:9113/metrics (nginx-prometheus-exporter) => (prometheus)
```shell
# nginx-prometheus-exporter 설치
wget https://github.com/nginxinc/nginx-prometheus-exporter/releases/download/v0.10.0/nginx-prometheus-exporter_0.10.0_linux_arm64.tar.gz -P /tmp/nginx-prometheus-exporter

tar -xvf /tmp/nginx-prometheus-exporter/nginx-prometheus-exporter_0.10.0_linux_arm64.tar.gz -C /tmp/nginx-prometheus-exporter

# nginx-prometheus-exporter 실행
./tmp/nginx-prometheus-exporter/nginx-prometheus-exporter -nginx.scrape-uri=http://localhost:80/metrics &
```
- nginx-prometheus-exporter 프로세스는 9113번 포트로 열림
- `-nginx.scrape-uri` 옵션을 통해 nginx stub module url 지정
- TODO : systemctl을 이용하여 데몬화 하는 방법 알아보기

```config
# /etc/nginx/conf.d/default.conf

# 추가
location = /metrics {
	stub_status on; # stub_status 활성화
	allow all; # allow 접근을 허용할 주소 설정
	# deny 접근을 허용하지 않을 주소 설정
}
```
- (nginx) => (nginx-prometheus-exporter) 연결

```yaml
# prometheus.yml

# 추가
- job_name: nginx
  static_configs:
    - targets: ['localhost:9113']
```
- (nginx-prometheus-exporter) => (prometheus) 연결
- nginx : nginx-prometheus-exporter 프로세스를 통해 nginx stub module 정보 수집

### grafana 설치

```shell
# grafana 설치
sudo apt-get install -y apt-transport-https software-properties-common wget
sudo mkdir -p /etc/apt/keyrings/
wget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor | sudo tee /etc/apt/keyrings/grafana.gpg > /dev/null
echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list
echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com beta main" | sudo tee -a /etc/apt/sources.list.d/grafana.list
# Updates the list of available packages
sudo apt-get update
# Installs the latest OSS release:
sudo apt-get install grafana

sudo systemctl daemon-reload
sudo systemctl start grafana-server
sudo systemctl status grafana-server

# To configure the Grafana server to start at boot
sudo systemctl enable grafana-server.service
```
- https://grafana.com/docs/grafana/latest/setup-grafana/installation/debian/

### grafana provisioning

```yaml
# /etc/grafana/provisioning/datasources/sample.yaml

# # config file version
apiVersion: 1

# # list of datasources that should be deleted from the database
#deleteDatasources:
#   - name: Graphite
#     orgId: 1

# # list of datasources to insert/update depending
# # on what's available in the database
datasources:
#   # <string, required> name of the datasource. Required
 - name: prometheus
#   # <string, required> datasource type. Required
   type: prometheus
#   # <string, required> access mode. direct or proxy. Required
   access: proxy
#   # <int> org id. will default to orgId 1 if not specified
#   orgId: 1
#   # <string> url
   url: http://localhost:9090
#   # <string> database user, if used
#   user:
#   # <string> database name, if used
#   database:
#   # <bool> enable/disable basic auth
#   basicAuth:
#   # <string> basic auth username
#   basicAuthUser:
#   # <bool> enable/disable with credentials headers
#   withCredentials:
#   # <bool> mark as default datasource. Max one per org
   isDefault: true
#   # <map> fields that will be converted to json and stored in json_data
#   jsonData:
#      httpMethod: POST
#      graphiteVersion: "1.1"
#      tlsAuth: true
#      tlsAuthWithCACert: true
#      httpHeaderName1: "Authorization"
#   # <string> json object of data that will be encrypted.
#   secureJsonData:
#     tlsCACert: "..."
#     tlsClientCert: "..."
#     tlsClientKey: "..."
#     # <openshift\kubernetes token example>
#     httpHeaderValue1: "Bearer xf5yhfkpsnmgo"
#   version: 1
#   # <bool> allow users to edit datasources from the UI.
   editable: false
```
- datasources(prometheus) 프로비저닝

```yaml
# /etc/grafana/provisioning/dashboards/sample.yaml

apiVersion: 1

providers:
 - name: 'default'
   orgId: 1
   folder: ''
   folderUid: ''
   type: file
   disableDeletion: false
   updateIntervalSeconds: 10
   options:
     path: /var/lib/grafana/dashboards
```
- `path` 디렉토리 안에 있는 모든 JSON 형식의 파일을 프로비저닝

```json
// /var/lib/grafana/dashboards/example.json

{
  "id": null,
  "uid": "example_dashboard_uid",
  "title": "Example Dashboard",
  "timezone": "browser",
  "schemaVersion": 22,
  "version": 0,
  "panels": [
    {
      "title": "CPU Usage",
      "type": "graph",
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "rate(node_cpu_seconds_total{mode=\"user\"}[5m]) * 100",
          "legendFormat": "{{mode}}"
        }
      ],
      "xaxis": {
        "show": true
      },
      "yaxes": [
        {
          "format": "percent",
          "label": "CPU Usage"
        },
        {
          "format": "short"
        }
      ],
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 0
      }
    }
  ],
  "refresh": "10s"
}
```
- dashboard 프로비저닝
- https://grafana.com/docs/grafana/latest/dashboards/build-dashboards/view-dashboard-json-model/

```shell
sudo systemctl daemon-reload
sudo systemctl restart grafana-server
```

### grafana internal metrics(optional)

```ini
# /etc/grafana/grafana.ini

# Metrics available at HTTP URL /metrics and /metrics/plugins/:pluginId
[metrics]
# Disable / Enable internal metrics
enabled           = true

# Disable total stats (stat_totals_*) metrics to be generated
disable_total_stats = false
```
- 세미콜론 제거
- https://grafana.com/docs/grafana/latest/setup-grafana/set-up-grafana-monitoring/

```shell
sudo systemctl restart grafana-server
```

```yml
# prometheus.yml

# 추가
- job_name: 'grafana_metrics'

   scrape_interval: 15s
   scrape_timeout: 5s

   static_configs:
     - targets: ['localhost:3000']
```

```shell
sudo systemctl restart prometheus
```

```
http://localhost:3000
```
- id : admin / pw : admin

## 2. k8s에서 nginx 모니터링 구축하기
