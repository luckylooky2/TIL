# 12.4 최초 입력 지연(FID)

## 정의

- First Input Delay
- 사용자가 최초로 페이지와 상호 작용할 때(e.g. 버튼 클릭)부터 상호 작용에 대한 응답으로 실제로 이벤트 핸들러 처리를 시작하기까지의 시간
- 즉, 사용자가 얼마나 빠르게 웹 페이지와의 상호작용에 대한 응답을 받을 수 있는지 측정하는 지표이다.
- 모든 입력이 아니고 최초의 입력에 대한 지연을 측정한다.
- 이벤트 핸들러가 완료되는 시간까지가 아니라 이벤트 핸들러가 호출되는 시점까지 측정한다.
- e.g. 수강 신청 페이지에서 엄청 큰 트래픽이 몰릴 때, 클릭이나 타이핑이 되지 않아 아무런 작업을 하지 못하는 상태

## 의미

- 웹 사이트 내부의 이벤트가 반응이 늦어지는 이유는?
  - 자바스크립트 실행 환경은 단일 스레드이고, 이 스레드가 바쁘기 때문이다.
  - 바쁜 이유는? 대규모 렌더링이 일어나고 있거나, 자바스크립트 파일을 분석하고 실행하는 데 시간이 걸리기 때문이다.
- 입력에 해당하는 것은? 클릭, 터치, 타이핑 등 사용자의 개별 입력 작업에 초점을 맞추고 측정한다(스크롤이나 핀치 투 줌은 애니메이션으로 분류한다).
- 구글 사용자 경험(RAIL)의 Response 부분에 해당한다.

## 예제

- 버튼을 클릭한 시점(2000ms)과 이벤트가 발생한 시점(2600ms)
- 클릭 이벤트가 발생한 시점에 메인 스레드가 다른 작업을 하고 있었다. 즉, 메인 스레드가 작업 중인 시점에 클릭 이벤트가 발생했다.

## 기준 점수

- Good: 100ms 이내
- Needs Improvement: 100ms ~ 300ms
- Poor: 300ms 이상

## 개선 방안

- 메인 스레드에 이벤트를 실행할 여유를 줘야 한다.

### 실행에 오래 걸리는 긴 작업을 분리

- FID 뿐만 아니라 웹 페이지 전반에 악영향을 미친다.
- 성능 탭에서 CPU 성능을 제한하여 열악한 기기로 테스트하는 것과 비슷한 환경을 만들 수 있다.
- 꼭 웹 페이지에서 해야 하는 작업인가? 서버로 옮겨서 처리할 수 있는 작업인가?
- 여러 작업으로 분리하기: 당장 필요하지 않은 리소스를 나중에 불러오는 것도 포함된다. 리액트의 Suspense, lazy 혹은 Next.js의 dynamic을 이용할 수 있다.

### 자바스크립트 코드 최소화

#### 커버리지

- 번들러가 필요 없는 코드를 제거해 준다고 하더라도, 여전히 경우에 따라 웹 페이지를 불러오는 데 사용되지 않는 코드가 있을 수 있다.
- 커버리지 탭에서 사용되지 않는 코드를 확인할 수 있다.
- 사용되지 않는 코드를 삭제하는 것은 위험할 수 있으므로, 지연 로딩 방식을 사용해 우선순위를 낮춰서 불러오는 것이 좋다.

#### 폴리필

- 브라우저에서 지원하지 않는 기능을 직접 구현한 코드. 최신 자바스크립트 문법을 지원하지 않는 구형 브라우저에서 사용하기 위해 사용된다.
- 폴리필은 생각보다 용량이 크다.
- 폴리필을 사용하기 전에 반드시 확인하자
  1.  폴리필이 필요한 환경인가? 애플리케이션에서 구형 브라우저를 지원하지 않는다면, 폴리필을 제거하자.
  2.  꼭 필요한 폴리필인가? 자주 사용되지 않는 폴리필은 직접 구현하자.
- @babel/preset-env, SWC 등을 사용하면 자동으로 사용하는 폴리필만 번들에 포함시키기 때문에 편하다.

### 타사 자바스크립트 코드 실행의 지연

- Google Analytics나 Firebase와 같이 통계 집계를 위해 타사 스크립트를 넣는 경우
- <script> 태그에서 async, defer 속성을 사용하면 된다. 이 속성을 사용하게 되면, 스크립트를 병렬로 다운로드한다. 하지만 실행 시점이 다르다.
  - 속성 없음: HTML 파싱 중단 후 다운로드, 실행 -> HTML 파싱 재개 (완전 동기)
  - async: 다운로드가 완료되면 즉시 실행. 실행 시 HTML 파싱이 중단 
  - defer: HTML 파싱이 완료된 후 마지막에 실행
- 광고와 같이 뷰포트 위치에 따라 불러와야 하는 컴포넌트라면 Intersection Observer API와 lazy를 사용해 뷰포트에 들어오는 시점에 불러오는 것이 좋다.
